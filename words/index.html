<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexGen | Words</title>
    <link rel="stylesheet" href="style.css?v=4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Google+Sans:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body>

    <div class="container">
        <header
            style="padding: 2rem 0; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" class="logo"
                style="font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; text-decoration: none;">
                wannabe <span class="gradient-text" style="margin-left: 0.3rem;">crazy lover</span>
            </a>
            <nav class="nav-links">
                <a href="../index.html">Home</a>
                <a href="../gallery.html">Gallery</a>
                <a href="../voice.html">Voice</a>
            </nav>
        </header>

        <main>
            <h2 style="color: var(--accent-secondary); font-size: 2rem; margin-bottom: 2rem; font-weight: 700;">Notes
            </h2>

            <!-- Featured Note (Center) -->
            <div id="featured-container" style="max-width: 800px; margin: 0 auto 3rem auto; display: none;">
                <!-- Injected via JS -->
            </div>

            <!-- JS Masonry Container -->
            <div id="notes-container"
                style="display: flex; gap: 1.5rem; justify-content: center; align-items: flex-start; max-width: 1400px; margin: 0 auto;">
                <div class="note-column"
                    style="flex: 1; display: flex; flex-direction: column; gap: 1.5rem; min-width: 0;"></div>
                <div class="note-column"
                    style="flex: 1; display: flex; flex-direction: column; gap: 1.5rem; min-width: 0;"></div>
                <div class="note-column"
                    style="flex: 1; display: flex; flex-direction: column; gap: 1.5rem; min-width: 0;"></div>
                <div class="note-column"
                    style="flex: 1; display: flex; flex-direction: column; gap: 1.5rem; min-width: 0;"></div>
            </div>
        </main>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="lightbox-overlay">
        <div class="lightbox-close" onclick="closeLightbox()">&times;</div>
        <div class="lightbox-content-wrapper" onclick="event.stopPropagation()">
            <div id="lightbox-card" class="note-card lightbox-card">
                <!-- Content injected here -->
            </div>
        </div>
        <button id="prev-btn" class="nav-btn prev-btn">&#10094;</button>
        <button id="next-btn" class="nav-btn next-btn">&#10095;</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const columns = document.querySelectorAll('.note-column');
            const lightbox = document.getElementById('lightbox');
            const lightboxCard = document.getElementById('lightbox-card');
            const featuredContainer = document.getElementById('featured-container');

            let allNotes = [];
            let currentIndex = -1;

            try {
                const response = await fetch('notes.json?t=' + Date.now());
                allNotes = await response.json();

                if (allNotes.length === 0) {
                    document.getElementById('notes-container').innerHTML = '<p style="text-align: center; color: var(--text-secondary); width: 100%;">No words yet.</p>';
                    return;
                }

                // --- Feature Specific Note Logic ---
                // Find "two red threads" (case insensitive)
                const featuredIndex = allNotes.findIndex(n => n.title.toLowerCase().includes('two red threads'));

                if (featuredIndex !== -1) {
                    const featuredNote = allNotes[featuredIndex];
                    // Remove from main list so it doesn't duplicate
                    allNotes.splice(featuredIndex, 1);

                    // Render into featured container
                    const fCard = createNoteCard(featuredNote);
                    fCard.style.border = '1px solid var(--accent-secondary)';
                    fCard.style.boxShadow = '0 0 20px rgba(168, 85, 247, 0.2)';

                    // Add click-zoom functionality
                    fCard.style.cursor = 'pointer';
                    fCard.onclick = () => {
                        openLightboxDirect(featuredNote);
                    };

                    featuredContainer.innerHTML = '';
                    featuredContainer.appendChild(fCard);
                    featuredContainer.style.display = 'block';
                }

                // Render notes using shortest-column distribution
                const columnHeights = new Array(columns.length).fill(0);

                allNotes.forEach((note, index) => {
                    const card = createNoteCard(note);
                    card.classList.add('animate-fade-in');
                    card.style.animationDelay = `${index * 0.05}s`;

                    // Click to open lightbox
                    card.style.cursor = 'pointer';
                    card.onclick = () => openLightbox(index);

                    // Find shortest column
                    let shortestColumnIndex = 0;
                    let minHeight = columnHeights[0];
                    for (let i = 1; i < columnHeights.length; i++) {
                        if (columnHeights[i] < minHeight) {
                            minHeight = columnHeights[i];
                            shortestColumnIndex = i;
                        }
                    }

                    columns[shortestColumnIndex].appendChild(card);
                    // Approximate height addition (1 for title + length of content)
                    columnHeights[shortestColumnIndex] += 1 + (note.content.length / 50);
                });

            } catch (error) {
                console.error('Failed to load notes:', error);
            }

            // --- Helper Functions ---

            function createNoteCard(note) {
                const card = document.createElement('div');
                card.className = 'note-card';

                let contentHtml = processContent(note.content);

                card.innerHTML = `
                    ${note.title ? `<h3 class="note-title">${note.title}</h3>` : ''}
                    <div class="note-content">${contentHtml}</div>
                `;
                return card;
            }

            function processContent(content) {
                if (content.includes('- [ ]') || content.includes('- [x]')) {
                    return parseChecklist(content);
                } else {
                    if (!content) return '';
                    // Nuclear Option: Collapse ALL whitespace (including \n\n) to single spaces
                    return content.replace(/\s+/g, ' ').trim();
                }
            }

            function parseChecklist(text) {
                return text.split('\n').map(line => {
                    if (line.includes('- [ ] ')) {
                        return `<div style="display: flex; gap: 0.5rem; align-items: start; margin-bottom: 0.25rem;">
                                    <div style="width: 14px; height: 14px; border: 2px solid var(--text-secondary); border-radius: 2px; margin-top: 3px;"></div>
                                    <span style="flex:1;">${line.replace('- [ ] ', '')}</span>
                                </div>`;
                    }
                    if (line.includes('- [x] ')) {
                        return `<div style="display: flex; gap: 0.5rem; align-items: start; margin-bottom: 0.25rem; opacity: 0.6; text-decoration: line-through;">
                                    <div style="width: 14px; height: 14px; background: var(--text-secondary); border: 2px solid var(--text-secondary); border-radius: 2px; margin-top: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: black;">âœ“</div>
                                    <span style="flex:1;">${line.replace('- [x] ', '')}</span>
                                </div>`;
                    }
                    return line;
                }).join('');
            }

            // --- Lightbox Logic ---

            window.openLightbox = function (index) {
                currentIndex = index;
                updateLightbox();
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            // Special handler for Featured note (no nav)
            function openLightboxDirect(note) {
                currentIndex = -1; // No nav context
                const contentHtml = processContent(note.content);
                lightboxCard.innerHTML = `
                    ${note.title ? `<h2 class="note-title" style="font-size: 2rem; margin-bottom: 1.5rem;">${note.title}</h2>` : ''}
                    <div class="note-content" style="font-size: 1.1rem; line-height: 1.6;">${contentHtml}</div>
                    <div style="margin-top: 2rem; color: var(--text-secondary); font-size: 0.9rem;">${note.date || ''}</div>
                `;
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            window.closeLightbox = function () {
                lightbox.classList.remove('active');
                document.body.style.overflow = 'auto';
            }

            function updateLightbox() {
                if (currentIndex < 0 || currentIndex >= allNotes.length) return;
                const note = allNotes[currentIndex];

                // Reuse card creation logic but add specific class
                const contentHtml = processContent(note.content);
                lightboxCard.innerHTML = `
                    ${note.title ? `<h2 class="note-title" style="font-size: 2rem; margin-bottom: 1.5rem;">${note.title}</h2>` : ''}
                    <div class="note-content" style="font-size: 1.1rem; line-height: 1.6;">${contentHtml}</div>
                    <div style="margin-top: 2rem; color: var(--text-secondary); font-size: 0.9rem;">${note.date || ''}</div>
                `;
            }

            function navigate(direction) {
                currentIndex += direction;
                if (currentIndex < 0) currentIndex = allNotes.length - 1;
                if (currentIndex >= allNotes.length) currentIndex = 0;
                updateLightbox();
            }

            // Event Listeners
            document.getElementById('prev-btn').onclick = (e) => { e.stopPropagation(); navigate(-1); };
            document.getElementById('next-btn').onclick = (e) => { e.stopPropagation(); navigate(1); };

            document.onclick = (e) => {
                if (e.target === lightbox) closeLightbox();
            }

            document.addEventListener('keydown', (e) => {
                if (!lightbox.classList.contains('active')) return;
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft') navigate(-1);
                if (e.key === 'ArrowRight') navigate(1);
            });

            // Responsiveness for columns
            function updateColumns() {
                const width = window.innerWidth;
                const container = document.getElementById('notes-container');
                const cols = container.querySelectorAll('.note-column');

                if (width <= 600) {
                    cols.forEach((c, i) => c.style.display = i < 1 ? 'flex' : 'none');
                } else if (width <= 900) {
                    cols.forEach((c, i) => c.style.display = i < 2 ? 'flex' : 'none');
                } else if (width <= 1200) {
                    cols.forEach((c, i) => c.style.display = i < 3 ? 'flex' : 'none');
                } else {
                    cols.forEach(c => c.style.display = 'flex');
                }
                // Note: Real resizing would require re-distributing notes. 
                // For now, simpler to just let them wrap or hide? 
                // Actually, CSS flex columns means hiding a column hides its content. 
                // The proper way is to re-run the render loop on resize.
                // But for this step let's just stick to the initial render. 
                // A full resize listener is better but complex.
            }
        });
    </script>
</body>

</html>