<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wannabe crazy lover</title>
    <!-- Styles -->
    <link rel="stylesheet" href="style.css?v=2">
    <!-- Font Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>

<body>
    <!-- Background -->
    <div class="ambient-light"></div>

    <!-- Navigation -->
    <header style="position: fixed; top: 0; width: 100%; padding: 2rem 0; z-index: 100; backdrop-filter: blur(5px);">
        <nav class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <div class="logo" onclick="window.location.href='index.html'"
                style="cursor: pointer; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px;">
                wannabe <span class="gradient-text">crazy lover</span>
            </div>
            <div class="nav-links" style="display: flex; gap: 2rem; color: var(--text-secondary);">
                <a href="index.html"
                    style="color: inherit; text-decoration: none; font-weight: 500; transition: color 0.3s; opacity: 0.7;">Home</a>
                <a href="#" style="color: var(--text-primary); text-decoration: none; font-weight: 500;">Chat</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="community-header animate-fade-in visible">
            <h1 style="font-size: 3rem; margin-bottom: 0.5rem;">Chat <span class="gradient-text">Voices</span></h1>
            <p style="color: var(--text-secondary); font-size: 1.1rem;">Drop a message, leave a mark.</p>
        </div>

        <div class="community-grid">
            <!-- Input Form -->
            <div class="message-form-card animate-fade-in visible">
                <h3 style="margin-bottom: 1rem;">Post a Message</h3>
                <div class="form-group">
                    <input type="text" id="nameInput" class="form-input" placeholder="Your Name or Alias"
                        maxlength="30">
                </div>
                <div class="form-group">
                    <textarea id="messageInput" class="form-textarea" placeholder="What's on your mind?"
                        maxlength="280"></textarea>
                </div>
                <button id="postBtn" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    Send Message
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            <!-- Message Feed -->
            <div class="message-feed" id="messageFeed">
                <!-- Loading State -->
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Loading messages...
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3wJAaup7xd_C1xX3NQTUnAOFduGFB-AA",
            authDomain: "sh-chat01.firebaseapp.com",
            projectId: "sh-chat01",
            storageBucket: "sh-chat01.firebasestorage.app",
            messagingSenderId: "604995349638",
            appId: "1:604995349638:web:3df48c1026bd24857a3507"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const messageFeed = document.getElementById('messageFeed');
        const postBtn = document.getElementById('postBtn');
        const nameInput = document.getElementById('nameInput');
        const messageInput = document.getElementById('messageInput');

        // Reference to messages collection
        const messagesRef = collection(db, "messages");

        // Listen for updates (Real-time!)
        const q = query(messagesRef, orderBy("timestamp", "desc"), limit(50));

        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                messageFeed.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">No messages yet. Be the first!</div>';
                return;
            }

            const html = snapshot.docs.map(docSnapshot => {
                const data = docSnapshot.data();
                const date = data.timestamp ? data.timestamp.toDate() : new Date();
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const authorColor = stringToColor(data.sender || 'Anonymous');

                return `
                    <div class="message-card">
                        <button class="delete-btn" data-id="${docSnapshot.id}" title="Delete Message">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                        <div class="message-header">
                            <div class="message-author" style="background: none; -webkit-background-clip: unset; background-clip: unset; -webkit-text-fill-color: currentColor; color: ${authorColor}; text-shadow: 0 0 15px ${authorColor}60;">${escapeHtml(data.sender || 'Anonymous')}</div>
                            <div class="message-date">${dateStr}</div>
                        </div>
                        <div class="message-content">${escapeHtml(data.content || '')}</div>
                    </div>
                `;
            }).join('');

            messageFeed.innerHTML = html;

            // Attach Delete Listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;

                    if (confirm('Delete this message permanently?')) {
                        // UI Feedback
                        const originalIcon = btn.innerHTML;
                        btn.innerHTML = '⏳';
                        btn.disabled = true;

                        try {
                            console.log("Attempting to delete doc:", id);
                            await deleteDoc(doc(db, "messages", id));
                            console.log("Delete successful");
                            // Success! onSnapshot will update the UI automatically.
                        } catch (error) {
                            console.error("Delete failed", error);
                            alert("❌ Delete Failed!\n\nReason: " + error.message + "\n\n(Check your database permissions in Firebase Console)");
                            // Revert button
                            btn.innerHTML = originalIcon;
                            btn.disabled = false;
                        }
                    }
                });
            });

        }, (error) => {
            console.error("Error listening to messages:", error);
            // SHOW THE ERROR ON SCREEN
            messageFeed.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 12px; margin-top: 2rem;">
                    <h3>Connection Error</h3>
                    <p style="font-family: monospace; font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                    <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 1rem;">Check Console (F12) for details.</p>
                </div>
            `;
        });

        // Send Message
        postBtn.addEventListener('click', async () => {
            const sender = nameInput.value.trim();
            const content = messageInput.value.trim();

            if (!sender || !content) {
                alert('Please fill in both fields.');
                return;
            }

            const originalText = postBtn.innerHTML;
            postBtn.innerHTML = 'Sending...';
            postBtn.disabled = true;

            try {
                await addDoc(messagesRef, {
                    sender: sender,
                    content: content,
                    timestamp: serverTimestamp()
                });
                messageInput.value = ''; // Clear message only
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Error sending message: " + error.message);
            } finally {
                postBtn.innerHTML = originalText;
                postBtn.disabled = false;
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function stringToColor(str) {
            let hash = 0;
            // DJB2 Hash (better distribution)
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i); /* hash * 33 + c */
            }

            // Allow negative hash to become positive, multiply by prime to spread similar strings
            const positiveHash = Math.abs(hash * 132049);

            // Hue: Use golden angle approximation to spread colors evenly
            const h = positiveHash % 360;
            const s = 75 + (positiveHash % 25); // 75-100% Saturation
            const l = 65 + (positiveHash % 15); // 65-80% Lightness

            return `hsl(${h}, ${s}%, ${l}%)`;
        }
    </script>

</body>

</html>